# This file is a template, and might need editing before it works on your project.
# You can copy and paste this template into a new `.gitlab-ci.yml` file.
# You should not add this template to an existing `.gitlab-ci.yml` file by using the `include:` keyword.
#
# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Swift.gitlab-ci.yml

# Lifted from: https://about.gitlab.com/2016/03/10/setting-up-gitlab-ci-for-ios-projects/
# This file assumes an own GitLab CI runner, setup on a macOS system.
stages:
  - build
  - test
  - archive

.configuration: &default_configuration
  tags:
    - ios_tag

# xcpretty - это компановщик для более удобного вида
build_project:
  <<: *default_configuration
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH != 'realise/realis' && $CI_COMMIT_BRANCH != 'main'
  script:
    - xcodebuild clean -project TestCICD.xcodeproj -scheme TestCICD | xcpretty

# only говорит о отом что сработает только в определенной ветке
# when: manual // можно заменить если хотим сделать в ручную
test_project:
  <<: *default_configuration
  stage: test
  only:
    - realise/realis
  script:
    - xcodebuild test -project TestCICD.xcodeproj -scheme TestCICD -destination 'platform=iOS Simulator,name=iPhone 8 Plus,OS=15.2' | xcpretty -s

archive_project:
  <<: *default_configuration
  stage: archive
  script:
    - xcodebuild clean archive -archivePath build/TestCICD -scheme TestCICD
    - xcodebuild -exportArchive -exportFormat ipa -archivePath "build/TestCICD.xcarchive" -exportPath "build/TestCICD.ipa" -exportProvisioningProfile "com.svetofor.auth.test.TestCICD"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  artifacts:
    paths:
      - build/TestCICD.ipa

# это был дефолтный
# stages:
#   - build
#   - test
#   - archive
#   - deploy
#
# build_project:
#   stage: build
#   script:
#     - xcodebuild clean -project ProjectName.xcodeproj -scheme SchemeName | xcpretty
#     - xcodebuild test -project ProjectName.xcodeproj -scheme SchemeName -destination 'platform=iOS Simulator,name=iPhone 8,OS=11.3' | xcpretty -s
#   tags:
#     - ios_11-3
#     - xcode_9-3
#     - macos_10-13
#
# archive_project:
#   stage: archive
#   script:
#     - xcodebuild clean archive -archivePath build/ProjectName -scheme SchemeName
#     - xcodebuild -exportArchive -exportFormat ipa -archivePath "build/ProjectName.xcarchive" -exportPath "build/ProjectName.ipa" -exportProvisioningProfile "ProvisioningProfileName"
#   rules:
#     - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
#   artifacts:
#     paths:
#       - build/ProjectName.ipa
#   tags:
#     - ios_11-3
#     - xcode_9-3
#     - macos_10-13
#
# deploy:
#   stage: deploy
#   script: echo "Define your deployment script!"
#   environment: production
